name: Deploy Full Stack to EC2

on:
  push:
    branches:
      - main   # ‡∏´‡∏£‡∏∑‡∏≠ branch ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì deploy ‡∏à‡∏£‡∏¥‡∏á

jobs:
  deploy:
    runs-on: self-hosted   # ‡πÉ‡∏ä‡πâ runner ‡∏ö‡∏ô EC2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via Docker Compose
        run: |
          set -e

          echo "üîÑ Pulling latest code..."
          # cd /home/ubuntu/pet-frontend
          git fetch --all
          git reset --hard origin/main

          # echo "üåê Building container..."
          # cd /home/ubuntu

          export $(grep -v '^#' .env | xargs)

          docker-compose down
          docker-compose build
          docker-compose up -d

          # üßπ ‡∏•‡πâ‡∏≤‡∏á image ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ
          docker image prune -f

          echo "‚úÖ Deployment completed successfully!"